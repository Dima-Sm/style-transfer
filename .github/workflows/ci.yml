name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Backend
      run: docker build -f Dockerfile.backend -t style-transfer-backend .

    - name: Build Frontend  
      run: docker build -f Dockerfile.frontend -t style-transfer-frontend .

    - name: Install curl for testing
      run: sudo apt-get update && sudo apt-get install -y curl

    - name: Run services in background
      run: |
        docker run -d --name backend -p 8000:8000 style-transfer-backend
        docker run -d --name frontend -p 80:80 style-transfer-frontend

    - name: Wait for services to be ready
      run: |
        echo "Waiting for backend (http://localhost:8000/docs)..."
        for i in {1..60}; do
          if curl -f http://localhost:8000/docs > /dev/null 2>&1; then
            echo "✅ Backend is ready!"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "❌ Backend failed to start"
            exit 1
          fi
          sleep 1
        done
        
        echo "Waiting for frontend (http://localhost)..."
        for i in {1..60}; do
          if curl -f http://localhost > /dev/null 2>&1; then
            echo "✅ Frontend is ready!"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "❌ Frontend failed to start"
            exit 1
          fi
          sleep 1
        done

    - name: Test API endpoint
      run: |
        echo "Testing /transfer endpoint..."
        response=$(curl -X POST http://localhost:8000/transfer -w "%{http_code}" -o /dev/null -s)
        if [[ $response == "422" || $response == "400" ]]; then
          echo "✅ API correctly rejects invalid requests"
        else
          echo "❌ API returned unexpected status: $response"
          exit 1
        fi

    - name: Test frontend delivers HTML
      run: |
        echo "Testing frontend..."
        curl -f http://localhost | grep -q "<title>Style Transfer</title>" && echo "✅ Frontend works"

    - name: Clean up containers
      if: always()
      run: |
        docker stop backend frontend 2>/dev/null || true
        docker rm backend frontend 2>/dev/null || true

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/master'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and push to Docker Hub (заглушка)
      run: echo "Deploy step completed (simulated for lab)"